
# Run localstack
With the docker-compose file included here you will only need to run 
```bash
docker compose up -d
```

# Localstack dashboard url
The following is the local dashboard for localstack = https://app.localstack.cloud/dashboard

# Publish Lambda
```bash
cd path_to_pom_file

mvn package
mvn clean package shade:shade

# Note: Change permissions to all files generated by publish command
chmod -R +rx ./bin/Release/net6.0/publish

# Zip lambda publish folder
## IMPORTANT: The -j flag is necessary to avoid using the local machine directory structure and only include in the zip the dll files
zip -r -j ./function.zip ./bin/Release/net6.0/publish/*
```

# Package lambda (This is an all in one command to publish the project, change permissions and zip it)
This is an alternative and easier way to create the lambda deployment package that was created in [Publish lambda](#publish-lambda) section
```bash
cd path_to_lambda_csproj

## Runtime can be also linux-x64
dotnet lambda package -pl ./ ./function.zip  -c Release -r linux-x64 --self-contained false
```

# Upload lambda
```
aws --endpoint-url=http://localhost:4566 \
lambda create-function --function-name Hello \
--zip-file fileb://target/my-notes-1.0-SNAPSHOT-aws.jar \
--architectures arm64 \
--runtime java21 \
--handler com.zeus.Handler::handleRequest \
--timeout 10 \
--memory-size 256 \
--environment Variables="{WEBHOOKAUTH__USER=aladdin,WEBHOOKAUTH__PASSWORD=opensesame,DOTNET_ENVIRONMENT=Development}" \
--role arn:aws:iam::000000000000:role/lambda-role \
--no-cli-pager
```

# Update lambda code
```
aws --endpoint-url=http://localhost:4566 \
lambda update-function-code \
--function-name Hello \
--zip-file fileb://target/my-notes-1.0-SNAPSHOT-aws.jar
```

# Wait function to be active (Only run it if you get a ResourceConflictException)
```bash
aws --endpoint-url=http://localhost:4566 lambda get-function --function-name Hello
aws --endpoint-url=http://localhost:4566 lambda wait function-active-v2 --function-name Hello
```


# Delete lambda
```bash
aws --endpoint-url=http://localhost:4566 lambda delete-function --function-name Hello
```

# Invoke function through cli
```bash
aws --endpoint-url=http://localhost:4566 lambda invoke --function-name Hello --payload "{}" response.json --log-type Tail
# for simple strings (not working)
aws --endpoint-url=http://localhost:4566 lambda invoke  --invocation-type RequestResponse  --function-name Hello --cli-binary-format raw-in-base64-out --payload "{\"a\":45, \"b\":\"Someing\"}" outputfile.txt

```

# Create a function URL
```bash
aws --endpoint-url=http://localhost:4566 lambda create-function-url-config --function-name Listener --auth-type NONE
```

# Get Function URL
```bash
aws --endpoint-url=http://localhost:4566 lambda get-function-url-config --function-name Listener
```


# Check lambda function logs
```bash
aws --endpoint-url=http://localhost:4566 logs tail '/aws/lambda/Listener' --follow
```


# RDS (This is a feature that is only available in the pro version of Localstack)

## Create database instance
Can be one of postgres, aurora-postgresql, mssql, etc
```bash
aws --endpoint-url=http://localhost:4566 rds create-db-cluster --db-cluster-identifier db1 --engine postgres --database-name sample_db
```
By default the user and password is test/test and the port is 4510. We can customize this by using ***--master-username, --master-user-password*** and ***port*** flags when creating the cluster.
Once the database is created, we can connect to it from our local machine just like any other instance of postgres using a connection string like this:
```
Host=localhost;Database=sample_db;Username=test;Password=test;Port=4510
```
If we want to connect to this **RDS** instance from inside a **Lambda** function running in the same localstack container, we must specify the **LOCALSTACK_HOST** environment variable when creating localstack, i.e., if the **LOCALSTACK_HOST** is set to *localstack*, the connection string to connect from **Lambda Function** to **RDS** instance should look like this:
```
Host=localstack;Port=4510;Database=sample_db;Username=test;Password=test
```


# SQS

## Create Queue
```bash
aws sqs create-queue --queue-name MyQueue --endpoint-url http://localhost:4566
```
## Create Event Source mapping
```bash
aws lambda create-event-source-mapping \
    --function-name Mapper \
    --batch-size 5 \
    --maximum-batching-window-in-seconds 60 \
    --event-source-arn arn:aws:sqs:us-east-1:000000000000:MyQueue \
    --endpoint-url http://localhost:4566
```
## Send message to queue
```bash
aws sqs send-message \
    --queue-url http://localhost:4566/000000000000/MyQueue \
    --message-body "Some random message or a json message" \
    --endpoint-url http://localhost:4566
```


# DynamoDB

## Create Table
```bash
# HASH is partition key and RANGE is sort key
aws dynamodb create-table \
--endpoint-url http://localhost:4566 \
--table-name Notes \
--key-schema \
    AttributeName=Id,KeyType=HASH \
--attribute-definitions \
    AttributeName=Id,AttributeType=S \
--billing-mode PAY_PER_REQUEST \
--region us-east-1 \
--no-cli-pager
```

## Put item
```bash
aws --endpoint-url http://localhost:4566 dynamodb put-item --table-name notes --item '{"Id":{"S":"something"}}' --region us-east-1
```

## Delete table
```bash
aws dynamodb delete-table \
    --endpoint-url http://localhost:4566 \
    --table-name Notes;
```

## Create S3 Bucket
```bash
aws s3api create-bucket \
    --endpoint-url http://localhost:4566 \
    --bucket crystal-choice \
    --create-bucket-configuration LocationConstraint=us-east-1 \
    --region us-east-1
```
